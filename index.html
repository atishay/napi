<html>
  <title>N-API in Electron</title>
  <style >
    html, body {
      background: #222;
      margin: 0;
      padding: 0;
    }
    * {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }
    h1, h2, p {
      text-align: center;
      color: #eee;
      margin: 5px;
    }
    #content {
      width:1024px;
      height:768px;
      position: relative;
      margin:0 auto;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #canvas, #image {
      display: none;
      max-width: 100%;
    }
    #video, #canvas, #image {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      top: 0;
      width:100%;
      height:100%;
      object-fit: contain;
    }
    a {
      display: none;
    }
  </style>
  <body>
    <h1>Cascadia JS 2018</h1>
    <h2>N API Souvenir Service</h2>
    <div id="content">
      <p>Click here above to start video, click again to get a souvenir. Then click to reset.</p>
      <img alt="Embedded Image" id="image" src="" />
      <video id="video" crossorigin="anonymous"></video>
      <canvas id="canvas" width="1024" height="768"></canvas>
    </div>
    <a download="CascadiaJS 2018 Souvenir.jpg"></a>
  </body>
  <script>
    const canvas = document.getElementById("canvas");
    const video = document.getElementById("video");
    const image = document.getElementById("image");
    const content = document.getElementById("content");
    const anchor = document.querySelector("a");
    const videoObj = { video: true, width: { exact: 1024 }, height: { exact: 768 } };

  window.addEventListener("DOMContentLoaded", () => {
    let videoStream = null;
    let stage = 0;
    let ignoreClicks = false;

    document.body.addEventListener("click", () => {
      if (ignoreClicks) return;
      document.querySelector("p").style.display = "none";
      switch(stage) {
        case 0:
        navigator.mediaDevices.getUserMedia(videoObj).then(stream => {
          videoStream = stream;
          video.srcObject = stream;
          video.onloadedmetadata = function(e) {
            video.play().catch(e => alert(e));
            image.style.display = "none";
            video.style.display = "block";
          }
        }, () => alert("Error capturing video"));
        break;
        case 1:
          const width = video.videoWidth;
          const height = video.videoHeight;
          canvas.width = width;
          canvas.height = height;

          video.pause();
          const context = canvas.getContext("2d");
          context.drawImage(video, 0, 0, canvas.width,  canvas.height);
          videoStream.getTracks()[0].stop()
          const data = canvas.toDataURL('image/jpg', 0.85);
          const fs = require('fs');
          const nativeImage = require('electron').nativeImage
          const photo = nativeImage.createFromDataURL(data).toJPEG(85);
          // fs.writeFileSync(__dirname + '/raw.jpg', photo);
          const editor = require("./build/Release/Edit.node");
          editor.edit(photo, (err, processed) => {
            const data = processed.toString('base64');
            image.src = "data:image/jpeg;base64," + data;
            image.style.display = "block";
            video.style.display = "none";
            anchor.href = image.src;
            setTimeout(() => {
              ignoreClicks = true;
              anchor.click();
              ignoreClicks = false;
            }, 100);
          });
          stage = -1;
          break;
      }
      stage++;
    });

    function handleResize() {
      // Handling sizes better.
      const width = window.innerWidth;
      const height = window.innerHeight  - content.offsetTop;
      content.style.width = width;
      content.style.height = height;
      videoObj.width.exact = width;
      videoObj.height.exact = height;
    }
    window.onresize = handleResize;
    handleResize();
  });

  </script>
</html>
